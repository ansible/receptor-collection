---
# if bin not exists we download it from github repo/tag

- name: Task name
  ansible.builtin.stat:
    path: "{{ local_receptor_path }}"
  register: local_receptor_stat

- name: Download receptor bin from github
  block:
    - name: Create receptor {{ local_receptor_path }}
      ansible.builtin.file:
        path: "{{ local_receptor_path }}"
        state: directory

    - name: Get latest release of receptor repository
      ansible.builtin.uri:
        url: "https://api.github.com/repos/{{ receptor_github_owner }}/{{ receptor_github_repo }}/releases/latest"
      register: latest_receptor_release

    - name: Download receptor from latest release
      ansible.builtin.get_url:
        url: "https://github.com/{{ receptor_github_owner }}/{{ receptor_github_repo }}/releases/download/{{ latest_receptor_release }}/{{ receptor_github_repo }}_{{ latest_receptor_release }}_linux_amd64.tar.gz"                     
        dest: "{{ local_receptor_path }}"/{{ receptor_github_repo }}_{{ latest_receptor_release }}_linux_amd64.tar.gz"
    
    - name: Unarchive receptor release
      ansible.builtin.unarchive:
        src: "{{ local_receptor_path }}//{{ receptor_github_repo }}_{{ latest_receptor_release }}_linux_amd64.tar.gz"
        dest: "{{ receptor_install_dir }}"
        remote_src: true

  when: not register_name.stat.exists

- name: Copy receptor's build to "{{ receptor_install_dir }}"
  ansible.builtin.copy:
    src: "{{ local_receptor_path }}/receptor"
    dest: "{{ receptor_install_dir }}/receptor"
    owner: root
    group: root
    mode: 'u=rwx,go=rx'
    remote_src: true
  when: register_name.stat.exists

- name: Add receptor's path to profile
  ansible.builtin.copy:
    dest: /etc/profile.d/receptor.sh
    content: "PATH=$PATH:{{ receptor_install_dir }}/receptor"
    owner: root
    group: root
    mode: 'u=rwx,go=rx'

- name: Create receptor's systemd service
  ansible.builtin.template:
    src: templates/receptor.service.j2
    dest: /lib/systemd/system/receptor.service
    mode: '0644'
    owner: root
    group: root
